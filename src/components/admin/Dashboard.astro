---
import Layout from "@/layouts/AdminLayout.astro";
import { db, Customers, Analytics, eq, desc } from "astro:db";
import EditIcon from "@/icons/admin/edit.astro";
import TrashIcon from "@/icons/admin/trash.astro";
import EyeIcon from "@/icons/admin/eye.astro";

// Fetch data
const customersData = await db
    .select()
    .from(Customers)
    .orderBy(desc(Customers.published));

// Analytics Data
const analyticsData = await db.select().from(Analytics);
const totalViews = analyticsData.filter((a) => a.type === "page_view").length;
const contactClicks = analyticsData.filter(
    (a) => a.type === "contact_click",
).length;
const whatsappClicks = analyticsData.filter(
    (a) => a.type === "whatsapp_click",
).length; // If added later

// Separate customers for potential filtering if needed, though table handles all
const enterprisesData = customersData.filter(
    (c) => c.category === "enterprise",
);
const privateCustomersData = customersData.filter(
    (c) => c.category === "privateCustomer",
);
---

<!-- Background -->
<div class="fixed inset-0 -z-10 bg-neutral-900">
    <div
        class="absolute inset-0 bg-[url('/img/carousel/protrait02.webp')] bg-cover bg-center opacity-20 blur-sm scale-105"
    >
    </div>
    <div class="absolute inset-0 bg-neutral-900/80 mix-blend-multiply"></div>
</div>

<div class="min-h-screen font-sans text-white p-6">
    <!-- Navbar -->
    <header
        class="sticky top-4 z-50 bg-white/10 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl px-6 py-4 mb-8 flex flex-col md:flex-row justify-between items-center gap-4"
    >
        <div class="flex items-center gap-4">
            <div
                class="p-2 bg-indigo-600/20 rounded-lg border border-indigo-500/30"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6 text-indigo-400"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"
                    ></path>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">
                    Dashboard & Analítica
                </h1>
                <p class="text-xs text-indigo-200">
                    Visión general del negocio
                </p>
            </div>
        </div>

        <nav class="flex items-center gap-3">
            <a
                href="/"
                class="px-4 py-2 rounded-lg bg-neutral-800/50 hover:bg-neutral-800 border border-white/5 text-sm font-medium transition-all hover:text-indigo-300 flex items-center gap-2"
            >
                Ir a Inicio
            </a>
            <form action="/api/auth/logout" method="POST">
                <button
                    type="submit"
                    class="px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-300 text-sm font-medium transition-all flex items-center gap-2"
                >
                    Cerrar Sesión
                </button>
            </form>
        </nav>
    </header>

    <!-- Analytics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-7xl mx-auto">
        <!-- Views -->
        <div
            class="bg-indigo-900/40 border border-indigo-500/20 rounded-xl p-6 flex flex-col relative overflow-hidden group"
        >
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/10 rounded-full blur-xl group-hover:bg-indigo-500/20 transition-all"
            >
            </div>
            <p
                class="text-indigo-200 text-xs font-medium uppercase tracking-wider mb-2"
            >
                Visitas Totales
            </p>
            <div class="flex items-baseline gap-2">
                <p class="text-4xl font-bold text-white">{totalViews}</p>
                <span class="text-xs text-indigo-300">páginas vistas</span>
            </div>
        </div>

        <!-- Contact Clicks -->
        <div
            class="bg-green-900/40 border border-green-500/20 rounded-xl p-6 flex flex-col relative overflow-hidden group"
        >
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full blur-xl group-hover:bg-green-500/20 transition-all"
            >
            </div>
            <p
                class="text-green-200 text-xs font-medium uppercase tracking-wider mb-2"
            >
                Interés de Contacto
            </p>
            <div class="flex items-baseline gap-2">
                <p class="text-4xl font-bold text-white">{contactClicks}</p>
                <span class="text-xs text-green-300">clics en forms</span>
            </div>
        </div>

        <!-- Inventory Stats -->
        <div
            class="bg-purple-900/40 border border-purple-500/20 rounded-xl p-6 flex flex-col relative overflow-hidden group"
        >
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/10 rounded-full blur-xl group-hover:bg-purple-500/20 transition-all"
            >
            </div>
            <p
                class="text-purple-200 text-xs font-medium uppercase tracking-wider mb-2"
            >
                Total Proyectos
            </p>
            <div class="flex items-baseline gap-2">
                <p class="text-4xl font-bold text-white">
                    {customersData.length}
                </p>
                <span class="text-xs text-purple-300">activos</span>
            </div>
            <div class="mt-auto pt-2 flex gap-2 text-xs text-white/50">
                <span>{enterprisesData.length} Empresas</span>
                <span>•</span>
                <span>{privateCustomersData.length} Particulares</span>
            </div>
        </div>
    </div>

    <!-- Data Table Section -->
    <main class="max-w-7xl mx-auto space-y-6">
        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white">Gestión de Contenido</h2>
            <div class="flex gap-2">
                <a
                    href="/admin/create?category=enterprise"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 transition-all flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"></path></svg
                    >
                    Añadir Empresa
                </a>
                <a
                    href="/admin/create?category=privateCustomer"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-purple-500/20 transition-all flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"></path></svg
                    >
                    Añadir Particular
                </a>
            </div>
        </div>

        <div
            class="bg-neutral-900/60 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden shadow-xl"
        >
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-indigo-100">
                    <thead
                        class="bg-white/5 text-xs uppercase text-indigo-300 font-bold tracking-wider"
                    >
                        <tr>
                            <th class="px-6 py-4">Imagen</th>
                            <th class="px-6 py-4">Título / ID</th>
                            <th class="px-6 py-4">Categoría</th>
                            <th class="px-6 py-4 text-center">Estado</th>
                            <th class="px-6 py-4">Fecha</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {
                            customersData.map((customer) => (
                                <tr class="hover:bg-white/5 transition-colors group">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="h-10 w-16 relative rounded overflow-hidden border border-white/10 bg-neutral-800">
                                            <img
                                                src={
                                                    ((customer.images as string[]) ||
                                                        [])[0] ||
                                                    "/img/placeholder.webp"
                                                }
                                                class="w-full h-full object-cover"
                                                loading="lazy"
                                            />
                                            <span class="absolute bottom-0 right-0 bg-black/60 text-[10px] text-white px-1 leading-none rounded-tl">
                                                {
                                                    (
                                                        (customer.images as string[]) ||
                                                        []
                                                    ).length
                                                }
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-white">
                                            {customer.title}
                                        </div>
                                        <div class="text-xs text-indigo-300/50">
                                            ID: {customer.customer_id}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span
                                            class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize ${
                                                customer.category ===
                                                "enterprise"
                                                    ? "bg-indigo-500/10 text-indigo-300 border border-indigo-500/20"
                                                    : "bg-purple-500/10 text-purple-300 border border-purple-500/20"
                                            }`}
                                        >
                                            {customer.category === "enterprise"
                                                ? "Empresa"
                                                : "Particular"}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <form
                                            action="/api/customers/toggle-visibility"
                                            method="POST"
                                            class="inline-block"
                                        >
                                            <input
                                                type="hidden"
                                                name="id"
                                                value={customer.customer_id}
                                            />
                                            <button
                                                type="submit"
                                                class={`px-2 py-1 rounded text-[0.65rem] font-bold uppercase tracking-wider border transition-all ${
                                                    customer.isVisible
                                                        ? "bg-green-500/10 text-green-400 border-green-500/20 hover:bg-green-500/20"
                                                        : "bg-neutral-500/10 text-neutral-500 border-neutral-500/20 hover:bg-neutral-500/20"
                                                }`}
                                            >
                                                {customer.isVisible
                                                    ? "Visible"
                                                    : "Oculto"}
                                            </button>
                                        </form>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-indigo-200/50">
                                        {new Date(
                                            customer.published,
                                        ).toLocaleDateString()}
                                    </td>
                                    <td class="px-6 py-4 text-right whitespace-nowrap">
                                        <div class="flex justify-end gap-2">
                                            <a
                                                href={`/productsDB/${customer.customer_id}`}
                                                target="_blank"
                                                class="p-1.5 rounded-lg hover:bg-white/10 text-indigo-300 hover:text-white transition-colors"
                                                title="Ver"
                                            >
                                                <EyeIcon class="w-4 h-4" />
                                            </a>
                                            <a
                                                href={`/admin/edit/${customer.customer_id}`}
                                                class="p-1.5 rounded-lg hover:bg-blue-500/20 text-blue-300 hover:text-blue-100 transition-colors"
                                                title="Editar"
                                            >
                                                <EditIcon class="w-4 h-4" />
                                            </a>
                                            <button
                                                data-id={customer.customer_id}
                                                class="delete-btn p-1.5 rounded-lg hover:bg-red-500/20 text-red-400 hover:text-red-100 transition-colors"
                                                title="Eliminar"
                                            >
                                                <TrashIcon class="w-4 h-4" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Delete Dialog -->
    <dialog
        id="removeDialog"
        class="fixed inset-0 m-auto bg-neutral-900/90 backdrop-blur-sm border border-white/10 text-white rounded-2xl p-0 shadow-2xl max-w-sm w-full overflow-hidden"
    >
        <div class="p-6 text-center">
            <div
                class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4"
            >
                <TrashIcon class="w-8 h-8 text-red-500" />
            </div>
            <h3 class="text-xl font-bold mb-2">¿Eliminar elemento?</h3>
            <p class="text-neutral-400 text-sm mb-6">
                Esta acción no se puede deshacer.
            </p>
            <footer class="flex gap-3 justify-center">
                <button
                    id="confirmNo"
                    class="px-5 py-2.5 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-white font-medium transition-colors"
                    >Cancelar</button
                >
                <form action="/api/customers/delete" method="POST">
                    <input
                        type="hidden"
                        name="id"
                        id="deleteInputId"
                        value=""
                    />
                    <button
                        type="submit"
                        class="px-5 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white font-medium shadow-lg shadow-red-500/20 transition-colors"
                        >Sí, eliminar</button
                    >
                </form>
            </footer>
        </div>
    </dialog>
</div>

<script>
    import { $ } from "@/consts/dom-selector";

    const removeDialog = $("#removeDialog") as HTMLDialogElement;
    const deleteInputId = $("#deleteInputId") as HTMLInputElement;
    const confirmNo = $("#confirmNo");

    document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        const deleteBtn = target.closest(".delete-btn"); // Class based selector

        if (deleteBtn) {
            const id = deleteBtn.getAttribute("data-id");
            if (id) {
                deleteInputId.value = id;
                removeDialog?.showModal();
            }
        }
    });

    confirmNo?.addEventListener("click", () => removeDialog?.close());
    removeDialog?.addEventListener("click", (e) => {
        if (e.target === removeDialog) removeDialog.close();
    });
</script>
