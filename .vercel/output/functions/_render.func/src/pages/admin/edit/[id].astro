---
import ReturnButton from "@/components/clients/ReturnButton.astro";
import Layout from "@/layouts/AdminLayout.astro";
import { db, Customers, isDbError, eq } from "astro:db";
import { v2 as cloudinary } from "cloudinary";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/admin");
}

let customer;
try {
    const result = await db
        .select()
        .from(Customers)
        .where(eq(Customers.customer_id, Number(id)));
    customer = result[0];
} catch (e) {
    console.error(e);
}

if (!customer) {
    return Astro.redirect("/admin");
}

const CATEGORIES = {
    ENTERPRISE: {
        key: "Enterprise",
        value: "enterprise",
    },
    PRIVATECUSTOMER: {
        key: "Private customer",
        value: "privateCustomer",
    },
};

// Configurar Cloudinary
cloudinary.config({
    api_key: import.meta.env.CLOUDINARY_API_KEY,
    api_secret: import.meta.env.CLOUDINARY_API_SECRET,
    cloud_name: import.meta.env.CLOUDINARY_CLOUD_NAME,
});

// Función para subir archivos a Cloudinary
// Note: In a real update scenario, we might want to handle image replacements or additions carefully.
// For simplicity, we are allowing adding new images (appending) or replacing if explicit logic added.
// Here we will just process new uploads if any.
const uploadStream = async (buffer: Uint8Array, options: any) => {
    return new Promise((resolve, reject) => {
        cloudinary.uploader
            .upload_stream(options, (error: any, result: unknown) => {
                if (error) return reject(error);
                resolve(result);
            })
            .end(buffer);
    });
};

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const title = data.get("title")?.toString();
    const description = data.get("description")?.toString();
    const category = data.get("category")?.toString();
    const files = data.getAll("images") as File[]; // New images

    // If new images are uploaded, add them.
    // Ideally we might want to keep existing ones.
    // For now, let's say we append new ones to the existing list if any.
    let currentImages = (customer.images as string[]) || [];

    const folder =
        category === CATEGORIES.PRIVATECUSTOMER.value
            ? `toldoperfil/privatecostumer`
            : `toldoperfil/enterprise/${title}`;

    const images_urls = [...currentImages];

    for (const file of files) {
        if (file.size > 0) {
            // Check if file is not empty
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            const response: any = await uploadStream(uint8Array, {
                folder: folder,
            });
            images_urls.push(response.url);
        }
    }

    try {
        await db
            .update(Customers)
            .set({
                title: title,
                description: description,
                category: category,
                images: images_urls,
            })
            .where(eq(Customers.customer_id, Number(id)));

        return Astro.redirect("/admin");
    } catch (e) {
        if (isDbError(e)) {
            console.error(e);
        }
    }
}
---

<Layout
    description="Editar cliente"
    title="Toldo Perfil - Editar"
    canonical="https://toldoperfil.es"
>
    <header
        class="relative flex justify-between gap-8 items-center font-sans px-4 py-6"
    >
        <ReturnButton href="/admin" label="Volver al panel" />
    </header>
    <main class="font-sans grid grid-cols-3 gap-3">
        <form class="" method="POST" enctype="multipart/form-data">
            <fieldset
                class="fixed top-1/2 left-1/2 w-72 -translate-x-1/2 -translate-y-1/2 flex flex-col gap-4 text-sm"
            >
                <h2 class="pb-4 text-2xl sm:text-3xl text-white font-bold">
                    Editar #{customer.customer_id}
                </h2>
                <div class="relative">
                    <label
                        for="title"
                        class="text-indigo-100 text-sm cursor-pointer"
                    >
                        Título
                    </label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        value={customer.title}
                        class="relative w-full py-1 px-4 outline-none text-indigo-100 placeholder-indigo-100 border-0 border-b border-indigo-100 cursor-pointer bg-transparent"
                    />
                </div>
                <div class="relative">
                    <label
                        for="category"
                        class="text-indigo-100 text-sm cursor-pointer"
                    >
                        Categoría
                    </label>
                    <select
                        name="category"
                        id="category"
                        class="relative w-full py-1 px-4 outline-none text-indigo-100 placeholder-indigo-100 border-0 border-b border-indigo-100 cursor-pointer bg-transparent"
                    >
                        {/* Pre-select logic */}
                        <option
                            value="enterprise"
                            selected={customer.category === "enterprise"}
                            >Enterprise</option
                        >
                        <option
                            value="privateCustomer"
                            selected={customer.category === "privateCustomer"}
                            >Private customers</option
                        >
                    </select>
                </div>

                <div class="relative">
                    <label
                        for="images"
                        class="text-indigo-100 text-sm cursor-pointer"
                    >
                        Añadir Imágenes (opcional):
                    </label>
                    <input
                        type="file"
                        name="images"
                        id="images"
                        class="relative w-full py-1 px-4 outline-none text-indigo-100 placeholder-indigo-100 cursor-pointer bg-transparent"
                        multiple
                    />
                </div>

                <div class="relative">
                    <label
                        for="description"
                        class="text-indigo-100 text-sm cursor-pointer"
                    >
                        Descripción
                    </label>
                    <textarea
                        name="description"
                        id="description"
                        class="relative w-full py-1 px-4 outline-none text-indigo-100 placeholder-indigo-400 border-0 border-b border-indigo-100 cursor-pointer bg-transparent resize-none"
                        >{customer.description}</textarea
                    >
                </div>
                <div>
                    <button
                        type="submit"
                        class="w-28 py-3 px-5 opacity-100[transition-property: translate] duration-200 ease-linear hover:-translate-y-0.5 button"
                    >
                        Guardar
                    </button>
                </div>
            </fieldset>
        </form>
    </main>
</Layout>
